<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="no-referrer">
<title>Nicole's Curiosity Box üîÆ</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0e;
    --surface: #11111a;
    --surface2: #181824;
    --border: #232336;
    --accent: #c8a96e;
    --accent2: #9d8df5;
    --accent3: #5ec4a8;
    --text: #e6e2d8;
    --muted: #635f78;
    --dim: #2e2c40;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    line-height: 1.7;
  }

  nav {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 24px 20px 0;
  }

  .nav-btn {
    font-family: 'Inter', sans-serif;
    font-size: 12px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    background: none;
    border: 1px solid var(--dim);
    border-radius: 20px;
    padding: 7px 18px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .nav-btn:hover, .nav-btn.active {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(200,169,110,0.06);
  }

  header {
    text-align: center;
    padding: 56px 24px 48px;
    position: relative;
    overflow: hidden;
  }

  .header-glow {
    position: absolute;
    top: -100px; left: 50%; transform: translateX(-50%);
    width: 700px; height: 420px;
    background: radial-gradient(ellipse, rgba(200,169,110,0.07) 0%, rgba(157,141,245,0.04) 45%, transparent 70%);
    pointer-events: none;
  }

  .site-eyebrow {
    font-size: 10px;
    letter-spacing: 5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 18px;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.4rem, 6vw, 4.2rem);
    font-weight: 400;
    line-height: 1.08;
    letter-spacing: -0.5px;
    margin-bottom: 10px;
  }

  h1 em { font-style: italic; color: var(--accent); }

  .tagline {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 44px;
  }

  .gen-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .gen-btn {
    background: linear-gradient(135deg, var(--accent) 0%, #a8824e 100%);
    border: none;
    border-radius: 12px;
    color: #0a0a0e;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 500;
    padding: 14px 36px;
    letter-spacing: 0.8px;
    transition: all 0.2s;
  }

  .gen-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(200,169,110,0.28); }
  .gen-btn:active { transform: translateY(0); }
  .gen-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }

  .error-msg { font-size: 12px; color: #f87171; min-height: 16px; text-align: center; }

  .page { display: none; }
  .page.active { display: block; }

  .loading { text-align: center; padding: 70px 20px; display: none; }
  .loading.show { display: block; }

  .loading-dots { display: flex; justify-content: center; gap: 10px; margin-bottom: 18px; }

  .dot {
    width: 9px; height: 9px;
    border-radius: 50%;
    animation: pulse 1.3s ease-in-out infinite;
  }

  .dot:nth-child(1) { background: var(--accent); }
  .dot:nth-child(2) { background: var(--accent2); animation-delay: 0.2s; }
  .dot:nth-child(3) { background: var(--accent3); animation-delay: 0.4s; }

  .loading-text { font-size: 13px; color: var(--muted); font-style: italic; }

  .date-header { text-align: center; padding: 16px 0 28px; display: none; }
  .date-header.show { display: block; animation: fadeUp 0.4s ease both; }
  .date-text { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--accent); font-style: italic; }
  .date-divider { width: 48px; height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 10px auto 0; }

  #today-cards, #history-cards {
    max-width: 760px;
    margin: 0 auto;
    padding: 0 20px 80px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 30px 34px;
    margin-bottom: 18px;
    position: relative;
    overflow: hidden;
    animation: fadeUp 0.5s ease both;
    transition: border-color 0.25s, transform 0.2s;
  }

  .card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(200,169,110,0.25), transparent);
  }

  .card:hover { border-color: rgba(200,169,110,0.22); transform: translateY(-2px); }
  .card:nth-child(1){animation-delay:.05s} .card:nth-child(2){animation-delay:.1s}
  .card:nth-child(3){animation-delay:.15s} .card:nth-child(4){animation-delay:.2s}
  .card:nth-child(5){animation-delay:.25s}

  .card-top { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
  .card-emoji { font-size: 30px; line-height: 1; flex-shrink: 0; }
  .card-num { font-size: 10px; color: var(--muted); letter-spacing: 2px; margin-bottom: 4px; }

  .card-cat {
    display: inline-block;
    font-size: 10px; letter-spacing: 0.8px;
    color: var(--accent2);
    background: rgba(157,141,245,0.1);
    border: 1px solid rgba(157,141,245,0.2);
    border-radius: 20px;
    padding: 2px 10px;
    text-transform: uppercase;
  }

  .card-title-en { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700; color: var(--text); line-height: 1.3; margin-bottom: 3px; }
  .card-title-zh { font-size: 13px; color: var(--muted); margin-bottom: 20px; font-style: italic; }

  .lang-tabs { display: flex; gap: 6px; margin-bottom: 14px; }

  .lang-tab {
    font-size: 11px; padding: 4px 13px;
    border-radius: 20px; cursor: pointer;
    border: 1px solid var(--border);
    color: var(--muted); background: none;
    font-family: 'Inter', sans-serif;
    transition: all 0.15s; letter-spacing: 0.5px;
  }

  .lang-tab.active { background: var(--surface2); border-color: var(--accent); color: var(--accent); }

  .content-block { display: none; }
  .content-block.active { display: block; animation: fadeIn 0.2s ease both; }

  .card-content { font-size: 14.5px; color: #aba7a0; line-height: 1.9; margin-bottom: 16px; }

  .card-insight {
    background: rgba(200,169,110,0.05);
    border-left: 2px solid rgba(200,169,110,0.5);
    border-radius: 0 8px 8px 0;
    padding: 10px 16px;
    font-size: 13px; color: #c4ab82;
    font-style: italic; margin-bottom: 16px; line-height: 1.65;
  }

  .card-source { font-size: 11px; color: var(--dim); }

  .card-source a {
    color: var(--muted); text-decoration: none;
    border-bottom: 1px solid var(--dim);
    transition: color 0.15s, border-color 0.15s;
    word-break: break-all;
  }

  .card-source a:hover { color: var(--accent); border-color: var(--accent); }

  .history-empty { text-align: center; padding: 80px 20px; color: var(--muted); font-size: 14px; font-style: italic; }

  .history-group {
    max-width: 760px; margin: 0 auto 40px;
    padding: 0 20px; animation: fadeUp 0.4s ease both;
  }

  .history-date-label {
    font-family: 'Playfair Display', serif;
    font-size: 1rem; color: var(--accent); font-style: italic;
    margin-bottom: 14px; padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }

  .history-delete {
    font-family: 'Inter', sans-serif;
    font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
    color: var(--dim); background: none;
    border: 1px solid var(--dim); border-radius: 10px;
    padding: 3px 10px; cursor: pointer; transition: all 0.15s;
  }

  .history-delete:hover { color: #f87171; border-color: #f87171; }

  .history-pills { display: flex; flex-wrap: wrap; gap: 8px; }

  .history-pill {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; color: var(--muted);
    background: var(--surface);
    border: 1px solid var(--border); border-radius: 20px;
    padding: 6px 14px; cursor: pointer; transition: all 0.15s;
  }

  .history-pill:hover { border-color: var(--accent2); color: var(--accent2); background: rgba(157,141,245,0.06); }
  .history-pill .pill-emoji { font-size: 14px; }

  .clear-all-wrap { max-width: 760px; margin: 0 auto 20px; padding: 0 20px; text-align: right; }

  .clear-all-btn {
    font-size: 11px; letter-spacing: 1px; text-transform: uppercase;
    color: var(--dim); background: none;
    border: 1px solid var(--dim); border-radius: 10px;
    padding: 5px 14px; cursor: pointer;
    font-family: 'Inter', sans-serif; transition: all 0.15s;
  }

  .clear-all-btn:hover { color: #f87171; border-color: #f87171; }

  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.8); z-index: 100;
    padding: 20px; overflow-y: auto;
    backdrop-filter: blur(6px);
  }

  .modal-overlay.show { display: flex; align-items: flex-start; justify-content: center; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 32px;
    max-width: 700px; width: 100%;
    margin: 40px auto; position: relative;
    animation: fadeUp 0.3s ease both;
  }

  .modal-close {
    position: absolute; top: 16px; right: 20px;
    background: none; border: none; color: var(--muted);
    font-size: 24px; cursor: pointer; line-height: 1; transition: color 0.15s;
  }

  .modal-close:hover { color: var(--text); }

  footer { text-align: center; padding: 36px 20px; font-size: 11px; color: var(--dim); border-top: 1px solid var(--border); letter-spacing: 1px; }

  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn  { from { opacity: 0; } to { opacity: 1; } }
  @keyframes pulse   { 0%,80%,100% { transform: scale(0.55); opacity: 0.35; } 40% { transform: scale(1); opacity: 1; } }

  @media (max-width: 600px) {
    .card { padding: 22px 18px; }
    h1 { font-size: 2.2rem; }
  }
</style>
</head>
<body>

<nav>
  <button class="nav-btn active" id="nav-today" onclick="showPage('today', this)">Today</button>
  <button class="nav-btn" id="nav-history" onclick="showPage('history', this)">Archive</button>
</nav>

<!-- TODAY -->
<div id="page-today" class="page active">
  <header>
    <div class="header-glow"></div>
    <div class="site-eyebrow">Nicole's Daily</div>
    <h1>Curiosity <em>Box</em> üîÆ</h1>
    <p class="tagline">5 surprising facts ¬∑ a different world every day</p>
    <div class="gen-wrap">
      <button class="gen-btn" id="genBtn" onclick="generate()">‚ú¶ Generate Today's Wonders</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>
  </header>

  <div class="loading" id="loading">
    <div class="loading-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <p class="loading-text">Collecting wonders from the corners of the universe‚Ä¶</p>
  </div>

  <div class="date-header" id="dateHeader">
    <div class="date-text" id="dateText"></div>
    <div class="date-divider"></div>
  </div>

  <div id="today-cards"></div>
</div>

<!-- HISTORY -->
<div id="page-history" class="page">
  <header>
    <div class="header-glow"></div>
    <div class="site-eyebrow">Nicole's Archive</div>
    <h1>Past <em>Wonders</em> üìö</h1>
    <p class="tagline">Everything you've discovered so far</p>
  </header>
  <div class="clear-all-wrap" id="clearAllWrap" style="display:none">
    <button class="clear-all-btn" onclick="clearAll()">Clear All History</button>
  </div>
  <div id="history-content"></div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
  <div class="modal" id="modalBox">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div id="modalBody"></div>
  </div>
</div>

<footer>MADE WITH CURIOSITY ¬∑ NICOLE'S WORLD üåç</footer>

<script>
  const STORAGE_KEY = 'ncb_v2';

  // ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
  function showPage(name, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    btn.classList.add('active');
    if (name === 'history') renderHistoryPage();
  }

  // ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ
  async function generate() {
    const btn    = document.getElementById('genBtn');
    const loader = document.getElementById('loading');
    const errEl  = document.getElementById('errorMsg');
    const cards  = document.getElementById('today-cards');
    const dh     = document.getElementById('dateHeader');

    btn.disabled = true;
    btn.textContent = 'Generating‚Ä¶';
    loader.classList.add('show');
    errEl.textContent = '';
    cards.innerHTML = '';
    dh.classList.remove('show');

    try {
      const res  = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ts: Date.now() })
      });

      const data = await res.json();
      if (!res.ok) { showError(data.error || 'Generation failed. Please try again.'); return; }

      renderCards(data.items, 'today-cards');
      saveEntry(data);

      document.getElementById('dateText').textContent = data.date;
      dh.classList.add('show');
      dh.scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch {
      showError('Network error. Please try again.');
    } finally {
      btn.disabled = false;
      btn.textContent = '‚ú¶ Generate Today\'s Wonders';
      loader.classList.remove('show');
    }
  }

  function showError(msg) {
    document.getElementById('errorMsg').textContent = msg;
    document.getElementById('loading').classList.remove('show');
    document.getElementById('genBtn').disabled = false;
    document.getElementById('genBtn').textContent = '‚ú¶ Generate Today\'s Wonders';
  }

  // ‚îÄ‚îÄ RENDER CARDS ‚îÄ‚îÄ
  function renderCards(items, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    items.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = buildCard(item, containerId + '_' + i);
      container.appendChild(div);
    });
  }

  function buildCard(item, uid) {
    return `
      <div class="card-top">
        <div class="card-emoji">${esc(item.emoji)}</div>
        <div>
          <div class="card-num">NO.${String(item.index).padStart(2,'0')}</div>
          <span class="card-cat">${esc(item.category)}</span>
        </div>
      </div>
      <div class="card-title-en">${esc(item.title_en)}</div>
      <div class="card-title-zh">${esc(item.title_zh)}</div>
      <div class="lang-tabs">
        <button class="lang-tab active" onclick="switchLang(this,'en','${uid}')">EN</button>
        <button class="lang-tab" onclick="switchLang(this,'zh','${uid}')">‰∏≠Êñá</button>
      </div>
      <div class="content-block active" id="en-${uid}">
        <p class="card-content">${esc(item.content_en)}</p>
        <div class="card-insight">${esc(item.insight_en)}</div>
      </div>
      <div class="content-block" id="zh-${uid}">
        <p class="card-content">${esc(item.content_zh)}</p>
        <div class="card-insight">${esc(item.insight_zh)}</div>
      </div>
      <div class="card-source">üìñ <a href="${esc(item.source_url)}" target="_blank" rel="noopener noreferrer">${esc(item.source_name)}</a></div>
    `;
  }

  function switchLang(btn, lang, uid) {
    const card = btn.closest('.card');
    card.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('active'));
    card.querySelectorAll('.content-block').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(lang + '-' + uid).classList.add('active');
  }

  // ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
  function loadHistory() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch { return []; }
  }

  function saveEntry(data) {
    try {
      let h = loadHistory().filter(e => e.date !== data.date);
      h.unshift({ date: data.date, items: data.items, savedAt: Date.now() });
      if (h.length > 60) h = h.slice(0, 60);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(h));
    } catch {}
  }

  function deleteEntry(date) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(loadHistory().filter(e => e.date !== date)));
      renderHistoryPage();
    } catch {}
  }

  function clearAll() {
    if (!confirm('Clear all history? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistoryPage();
  }

  // ‚îÄ‚îÄ HISTORY PAGE ‚îÄ‚îÄ
  function renderHistoryPage() {
    const history = loadHistory();
    const container = document.getElementById('history-content');
    const clearWrap = document.getElementById('clearAllWrap');

    if (!history.length) {
      container.innerHTML = '<div class="history-empty">No wonders saved yet.<br>Generate your first batch on the Today tab!</div>';
      clearWrap.style.display = 'none';
      return;
    }

    clearWrap.style.display = 'block';
    container.innerHTML = '';
    window._hist = history;

    history.forEach((entry, gi) => {
      const g = document.createElement('div');
      g.className = 'history-group';
      g.style.animationDelay = (gi * 0.04) + 's';
      g.innerHTML = `
        <div class="history-date-label">
          <span>${esc(entry.date)}</span>
          <button class="history-delete" onclick="deleteEntry('${esc(entry.date)}')">Delete</button>
        </div>
        <div class="history-pills">
          ${entry.items.map((item, ii) => `
            <div class="history-pill" onclick="openModal(${gi})">
              <span class="pill-emoji">${esc(item.emoji)}</span>
              <span>${esc(item.title_en)}</span>
            </div>
          `).join('')}
        </div>
      `;
      container.appendChild(g);
    });
  }

  // ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
  function openModal(gi) {
    const entry = (window._hist || loadHistory())[gi];
    if (!entry) return;

    const body = document.getElementById('modalBody');
    body.innerHTML = `
      <div style="text-align:center;margin-bottom:24px">
        <span style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--accent);font-style:italic">${esc(entry.date)}</span>
      </div>
      <div id="modal-inner"></div>
    `;
    entry.items.forEach((item, i) => {
      const d = document.createElement('div');
      d.className = 'card';
      d.style.marginBottom = '14px';
      d.innerHTML = buildCard(item, 'modal_' + gi + '_' + i);
      document.getElementById('modal-inner').appendChild(d);
    });

    document.getElementById('modalOverlay').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('show');
    document.body.style.overflow = '';
  }

  function closeModalOutside(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  }

  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

  // ‚îÄ‚îÄ XSS PROTECTION ‚îÄ‚îÄ
  function esc(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // ‚îÄ‚îÄ INIT: show last session ‚îÄ‚îÄ
  (function() {
    const h = loadHistory();
    if (!h.length) return;
    const last = h[0];
    renderCards(last.items, 'today-cards');
    document.getElementById('dateText').textContent = last.date;
    document.getElementById('dateHeader').classList.add('show');
  })();
</script>
</body>
</html>
