<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta name="referrer" content="no-referrer">
<title>Curiosity Box</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #fafaf8;
    --white: #ffffff;
    --text: #1a1a1a;
    --muted: #8a8a8a;
    --light: #c8c8c4;
    --border: #ebebeb;
    --tag-bg: #f2f2f0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 16px; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 300;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    max-width: 680px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* ── NAV ── */
  nav {
    padding: 32px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .nav-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.05rem;
    color: var(--text);
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .clear-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--light);
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.15s;
    display: none;
  }

  .clear-btn:hover { color: #c0392b; }
  .clear-btn.show { display: block; }

  /* ── HEADER ── */
  .page-header {
    padding: 72px 0 56px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 56px;
  }

  .eyebrow {
    font-size: 11px;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
    font-weight: 400;
  }

  h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2.4rem, 5vw, 3.6rem);
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: -0.5px;
    color: var(--text);
    margin-bottom: 16px;
  }

  h1 em { font-style: italic; color: var(--muted); }

  .tagline {
    font-size: 15px;
    color: var(--muted);
    font-weight: 300;
    line-height: 1.6;
    max-width: 420px;
    margin-bottom: 40px;
  }

  /* ── GENERATE AREA ── */
  .gen-area {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .password-input {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 300;
    color: var(--text);
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    width: 160px;
    outline: none;
    transition: border-color 0.15s;
  }

  .password-input::placeholder { color: var(--light); }
  .password-input:focus { border-color: var(--text); }

  .gen-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    background: var(--text);
    color: var(--white);
    border: none;
    border-radius: 8px;
    padding: 11px 24px;
    cursor: pointer;
    transition: opacity 0.15s;
    white-space: nowrap;
  }

  .gen-btn:hover { opacity: 0.75; }
  .gen-btn:active { opacity: 0.6; }
  .gen-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .error-msg {
    width: 100%;
    font-size: 13px;
    color: #c0392b;
    min-height: 16px;
  }

  /* ── LOADING ── */
  .loading { display: none; padding: 56px 0; text-align: center; }
  .loading.show { display: block; }

  .loading-bar {
    width: 48px; height: 2px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 18px;
    overflow: hidden;
    position: relative;
  }

  .loading-bar::after {
    content: '';
    position: absolute; left: -100%; width: 100%; height: 100%;
    background: var(--text);
    animation: slide 1s ease-in-out infinite;
  }

  .loading-text { font-size: 13px; color: var(--muted); font-weight: 300; }

  /* ── DATE SECTION HEADER ── */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }

  .section-date {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 400;
  }

  .section-delete {
    font-size: 11px;
    color: var(--light);
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: color 0.15s;
    padding: 0;
  }

  .section-delete:hover { color: #c0392b; }

  /* ── DATE GROUP ── */
  .date-group {
    margin-bottom: 64px;
    animation: fadeUp 0.4s ease both;
  }

  /* ── CARDS ── */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 12px;
    transition: box-shadow 0.2s;
  }

  .card:hover { box-shadow: 0 4px 24px rgba(0,0,0,0.05); }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 18px;
  }

  .card-left { display: flex; align-items: center; gap: 10px; }
  .card-emoji { font-size: 20px; line-height: 1; }

  .card-cat {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .card-num {
    font-size: 11px;
    color: var(--light);
    letter-spacing: 1px;
  }

  .card-title-en {
    font-family: 'DM Serif Display', serif;
    font-size: 1.3rem;
    font-weight: 400;
    line-height: 1.3;
    color: var(--text);
    margin-bottom: 4px;
    letter-spacing: -0.2px;
  }

  .card-title-zh {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
    font-weight: 300;
  }

  .lang-tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 16px;
    background: var(--tag-bg);
    border-radius: 7px;
    padding: 3px;
    width: fit-content;
  }

  .lang-tab {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    padding: 4px 14px;
    border-radius: 5px;
    border: none;
    background: none;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .lang-tab.active {
    background: var(--white);
    color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }

  .content-block { display: none; }
  .content-block.active { display: block; animation: fadeIn 0.2s ease both; }

  .card-content {
    font-size: 15px;
    color: #444;
    line-height: 1.85;
    margin-bottom: 16px;
    font-weight: 300;
  }

  .card-insight {
    font-size: 13.5px;
    color: var(--muted);
    font-style: italic;
    line-height: 1.65;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    margin-bottom: 16px;
  }

  .card-source { font-size: 12px; color: var(--light); }

  .card-source a {
    color: var(--muted);
    text-decoration: none;
    border-bottom: 1px solid var(--border);
    transition: color 0.15s;
  }

  .card-source a:hover { color: var(--text); }

  /* ── EMPTY STATE ── */
  .empty-state {
    text-align: center;
    padding: 64px 0 80px;
    color: var(--muted);
    font-size: 14px;
    font-weight: 300;
    line-height: 1.8;
  }

  /* ── FOOTER ── */
  footer {
    border-top: 1px solid var(--border);
    padding: 28px 0;
    font-size: 12px;
    color: var(--light);
    letter-spacing: 0.5px;
  }

  /* ── ANIMATIONS ── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  @keyframes slide {
    0%   { left: -100%; }
    100% { left: 100%; }
  }

  @media (max-width: 600px) {
    .card { padding: 22px 18px; }
    h1 { font-size: 2.2rem; }
    .gen-area { flex-direction: column; align-items: flex-start; }
    .password-input { width: 100%; }
  }
</style>
</head>
<body>

<div class="container">
  <nav>
    <span class="nav-logo">Curiosity Box</span>
    <div class="nav-right">
      <button class="clear-btn" id="clearBtn" onclick="clearAll()">Clear all</button>
    </div>
  </nav>

  <div class="page-header">
    <div class="eyebrow">Nicole's Daily</div>
    <h1>Five things<br>worth <em>knowing.</em></h1>
    <p class="tagline">Surprising, sharp, and a little wicked — one curiosity box per day.</p>

    <div class="gen-area">
      <input
        type="password"
        class="password-input"
        id="passwordInput"
        placeholder="Password"
        onkeydown="if(event.key==='Enter') generate()"
      />
      <button class="gen-btn" id="genBtn" onclick="generate()">Generate</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="loading-bar"></div>
    <p class="loading-text">Collecting wonders…</p>
  </div>

  <!-- All entries, newest first -->
  <div id="all-entries"></div>

  <!-- Empty state -->
  <div class="empty-state" id="emptyState">
    Nothing here yet.<br>Enter your password and generate today's wonders.
  </div>

  <footer>Made with curiosity · Nicole's World</footer>
</div>

<script>
  const STORAGE_KEY = 'ncb_v3';

  // ── GENERATE ──
  async function generate() {
    const password = document.getElementById('passwordInput').value.trim();
    if (!password) { showError('Enter password'); return; }

    const btn    = document.getElementById('genBtn');
    const loader = document.getElementById('loading');
    const errEl  = document.getElementById('errorMsg');

    btn.disabled = true;
    btn.textContent = 'Generating…';
    loader.classList.add('show');
    errEl.textContent = '';

    try {
      const res  = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password, timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, ts: Date.now() })
      });

      const data = await res.json();
      if (!res.ok) { showError(data.error || 'Generation failed. Please try again.'); return; }

      saveEntry(data);
      renderAll();

      // Scroll to top of entries
      document.getElementById('all-entries').scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch {
      showError('Network error. Please try again.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
      loader.classList.remove('show');
    }
  }

  function showError(msg) {
    document.getElementById('errorMsg').textContent = msg;
    document.getElementById('loading').classList.remove('show');
    document.getElementById('genBtn').disabled = false;
    document.getElementById('genBtn').textContent = 'Generate';
  }

  // ── RENDER ALL ENTRIES (newest first) ──
  function renderAll() {
    const history = loadHistory();
    const container = document.getElementById('all-entries');
    const emptyState = document.getElementById('emptyState');
    const clearBtn = document.getElementById('clearBtn');

    container.innerHTML = '';

    if (!history.length) {
      emptyState.style.display = 'block';
      clearBtn.classList.remove('show');
      return;
    }

    emptyState.style.display = 'none';
    clearBtn.classList.add('show');

    history.forEach((entry, gi) => {
      const group = document.createElement('div');
      group.className = 'date-group';
      group.style.animationDelay = (gi * 0.05) + 's';

      // Section header
      const header = document.createElement('div');
      header.className = 'section-header';
      header.innerHTML = `
        <span class="section-date">${esc(entry.date)}</span>
        <button class="section-delete" onclick="deleteEntry('${esc(entry.date)}')">Delete</button>
      `;
      group.appendChild(header);

      // Cards
      entry.items.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = buildCard(item, 'g' + gi + '_' + i);
        group.appendChild(card);
      });

      container.appendChild(group);
    });
  }

  // ── BUILD CARD HTML ──
  function buildCard(item, uid) {
    return `
      <div class="card-top">
        <div class="card-left">
          <span class="card-emoji">${esc(item.emoji)}</span>
          <span class="card-cat">${esc(item.category)}</span>
        </div>
        <span class="card-num">${String(item.index).padStart(2,'0')}</span>
      </div>
      <div class="card-title-en">${esc(item.title_en)}</div>
      <div class="card-title-zh">${esc(item.title_zh)}</div>
      <div class="lang-tabs">
        <button class="lang-tab active" onclick="switchLang(this,'en','${uid}')">EN</button>
        <button class="lang-tab" onclick="switchLang(this,'zh','${uid}')">中文</button>
      </div>
      <div class="content-block active" id="en-${uid}">
        <p class="card-content">${esc(item.content_en)}</p>
        <div class="card-insight">${esc(item.insight_en)}</div>
      </div>
      <div class="content-block" id="zh-${uid}">
        <p class="card-content">${esc(item.content_zh)}</p>
        <div class="card-insight">${esc(item.insight_zh)}</div>
      </div>
      <div class="card-source">Source: <a href="${esc(item.source_url)}" target="_blank" rel="noopener noreferrer">${esc(item.source_name)}</a></div>
    `;
  }

  // ── LANG TOGGLE ──
  function switchLang(btn, lang, uid) {
    const card = btn.closest('.card');
    card.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('active'));
    card.querySelectorAll('.content-block').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(lang + '-' + uid).classList.add('active');
  }

  // ── STORAGE ──
  function loadHistory() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch { return []; }
  }

  function saveEntry(data) {
    try {
      let h = loadHistory().filter(e => e.date !== data.date);
      h.unshift({ date: data.date, items: data.items, savedAt: Date.now() });
      if (h.length > 60) h = h.slice(0, 60);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(h));
    } catch {}
  }

  function deleteEntry(date) {
    if (!confirm('Delete this entry?')) return;
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(loadHistory().filter(e => e.date !== date)));
      renderAll();
    } catch {}
  }

  function clearAll() {
    if (!confirm('Clear all history? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderAll();
  }

  // ── XSS PROTECTION ──
  function esc(str) {
    if (typeof str !== 'string') return '';
    return str
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // ── INIT ──
  renderAll();
</script>
</body>
</html>
