<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<title>Curiosity Box</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #fafaf8;
    --white: #ffffff;
    --text: #1a1a1a;
    --muted: #8a8a8a;
    --light: #c8c8c4;
    --border: #ebebeb;
    --tag-bg: #f2f2f0;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 16px; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 300;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    max-width: 680px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* ── NAV ── */
  nav {
    padding: 32px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .nav-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.05rem;
    color: var(--text);
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .nav-pill {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--light);
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.15s;
    display: none;
  }

  .nav-pill:hover { color: var(--text); }
  .nav-pill.danger:hover { color: #c0392b; }
  .nav-pill.show { display: inline-block; }

  /* ── HEADER ── */
  .page-header {
    padding: 72px 0 40px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
  }

  .eyebrow {
    font-size: 11px;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
    font-weight: 400;
  }

  h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2.4rem, 5vw, 3.6rem);
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: -0.5px;
    color: var(--text);
    margin-bottom: 16px;
  }

  h1 em { font-style: italic; color: var(--muted); }

  .tagline {
    font-size: 15px;
    color: var(--muted);
    font-weight: 300;
    line-height: 1.6;
    max-width: 420px;
    margin-bottom: 32px;
  }

  /* ── GENERATE AREA ── */
  .gen-area {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .password-input {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 300;
    color: var(--text);
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    width: 160px;
    outline: none;
    transition: border-color 0.15s;
  }

  .password-input::placeholder { color: var(--light); }
  .password-input:focus { border-color: var(--text); }

  .gen-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    background: var(--text);
    color: var(--white);
    border: none;
    border-radius: 8px;
    padding: 11px 24px;
    cursor: pointer;
    transition: opacity 0.15s;
    white-space: nowrap;
  }

  .gen-btn:hover { opacity: 0.75; }
  .gen-btn:active { opacity: 0.6; }
  .gen-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .error-msg {
    width: 100%;
    font-size: 13px;
    color: #c0392b;
    min-height: 16px;
  }

  /* ── LOADING ── */
  .loading { display: none; padding: 44px 0 14px; text-align: center; }
  .loading.show { display: block; }

  .loading-bar {
    width: 48px; height: 2px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 18px;
    overflow: hidden;
    position: relative;
  }

  .loading-bar::after {
    content: '';
    position: absolute; left: -100%; width: 100%; height: 100%;
    background: var(--text);
    animation: slide 1s ease-in-out infinite;
  }

  .loading-text { font-size: 13px; color: var(--muted); font-weight: 300; }

  /* ── ARCHIVE BAR ── */
  .archive-bar{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:16px;
    margin: 10px 0 28px;
    padding-bottom:14px;
    border-bottom:1px solid var(--border);
  }

  .archive-title{
    font-family:'DM Serif Display', serif;
    font-size:1.1rem;
    color:var(--text);
    margin-bottom:2px;
  }

  .archive-sub{
    font-size:12px;
    color:var(--muted);
  }

  .archive-right{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .filter-select, .filter-input{
    font-family:'DM Sans', sans-serif;
    font-size:13px;
    color:var(--text);
    background:var(--white);
    border:1px solid var(--border);
    border-radius:8px;
    padding:10px 12px;
    outline:none;
  }

  .filter-input{ width:220px; }
  .filter-select:focus, .filter-input:focus{ border-color:var(--text); }

  /* ── DATE SECTION HEADER ── */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }

  .section-date {
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 400;
  }

  .section-meta {
    display:flex;
    align-items:center;
    gap:10px;
    font-size: 11px;
    color: var(--light);
  }

  .section-delete {
    font-size: 11px;
    color: var(--light);
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: color 0.15s;
    padding: 0;
  }

  .section-delete:hover { color: #c0392b; }

  /* ── DATE GROUP ── */
  .date-group {
    margin-bottom: 64px;
    animation: fadeUp 0.4s ease both;
  }

  /* ── CARDS ── */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 12px;
    transition: box-shadow 0.2s;
  }

  .card:hover { box-shadow: 0 4px 24px rgba(0,0,0,0.05); }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 18px;
  }

  .card-left { display: flex; align-items: center; gap: 10px; }
  .card-emoji { font-size: 20px; line-height: 1; }

  .card-cat {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .card-num {
    font-size: 11px;
    color: var(--light);
    letter-spacing: 1px;
  }

  .card-title-en {
    font-family: 'DM Serif Display', serif;
    font-size: 1.3rem;
    font-weight: 400;
    line-height: 1.3;
    color: var(--text);
    margin-bottom: 4px;
    letter-spacing: -0.2px;
  }

  .card-title-zh {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
    font-weight: 300;
  }

  .lang-tabs {
    display: flex;
    gap: 2px;
    margin-bottom: 16px;
    background: var(--tag-bg);
    border-radius: 7px;
    padding: 3px;
    width: fit-content;
  }

  .lang-tab {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    padding: 4px 14px;
    border-radius: 5px;
    border: none;
    background: none;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .lang-tab.active {
    background: var(--white);
    color: var(--text);
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }

  .content-block { display: none; }
  .content-block.active { display: block; animation: fadeIn 0.2s ease both; }

  .card-content {
    font-size: 15px;
    color: #444;
    line-height: 1.85;
    margin-bottom: 16px;
    font-weight: 300;
  }

  .card-insight {
    font-size: 13.5px;
    color: var(--muted);
    font-style: italic;
    line-height: 1.65;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    margin-bottom: 16px;
  }

  .card-source { font-size: 12px; color: var(--light); }

  .card-source a, .card-source span {
    color: var(--muted);
    text-decoration: none;
    border-bottom: 1px solid var(--border);
    transition: color 0.15s;
    margin-right: 10px;
    display: inline-block;
  }

  .card-source a:hover { color: var(--text); }

  /* ── EMPTY STATE ── */
  .empty-state {
    text-align: center;
    padding: 64px 0 80px;
    color: var(--muted);
    font-size: 14px;
    font-weight: 300;
    line-height: 1.8;
  }

  /* ── FOOTER ── */
  footer {
    border-top: 1px solid var(--border);
    padding: 28px 0;
    font-size: 12px;
    color: var(--light);
    letter-spacing: 0.5px;
    margin-top: 48px;
  }

  /* ── ANIMATIONS ── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  @keyframes slide {
    0%   { left: -100%; }
    100% { left: 100%; }
  }

  @media (max-width: 600px) {
    .card { padding: 22px 18px; }
    h1 { font-size: 2.2rem; }
    .gen-area { flex-direction: column; align-items: flex-start; }
    .password-input { width: 100%; }

    .archive-bar{ align-items:flex-start; flex-direction:column; }
    .archive-right{ width:100%; justify-content:flex-start; }
    .filter-input{ width:100%; }
  }
</style>
</head>

<body>
<div class="container">
  <nav>
    <span class="nav-logo">Curiosity Box</span>
    <div class="nav-right">
      <button class="nav-pill show" id="adminBtn" onclick="toggleAdmin()">Admin</button>
      <button class="nav-pill danger" id="clearBtn" onclick="clearAll()">Clear all</button>
    </div>
  </nav>

  <div class="page-header">
    <div class="eyebrow">Nicole's Daily</div>
    <h1>Five things<br>worth <em>knowing.</em></h1>
    <p class="tagline">Surprising, sharp, and a little wicked — one curiosity box per day.</p>

    <div class="gen-area">
      <input
        type="password"
        class="password-input"
        id="passwordInput"
        placeholder="Password"
        onkeydown="if(event.key==='Enter') generate()"
      />
      <button class="gen-btn" id="genBtn" onclick="generate()">Generate</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="loading-bar"></div>
    <p class="loading-text">Collecting wonders…</p>
  </div>

  <!-- Archive controls -->
  <div class="archive-bar">
    <div class="archive-left">
      <div class="archive-title">Archive</div>
      <div class="archive-sub">Saved in this browser (read-only for visitors). Admin can delete.</div>
    </div>

    <div class="archive-right">
      <select id="filterCategory" class="filter-select" onchange="renderArchive()">
        <option value="ALL">All categories</option>
        <option value="Psychology">Psychology</option>
        <option value="History">History</option>
        <option value="Nature">Nature</option>
        <option value="Culture">Culture</option>
        <option value="Philosophy">Philosophy</option>
        <option value="Language">Language</option>
        <option value="Food">Food</option>
        <option value="Art">Art</option>
        <option value="Science">Science</option>
        <option value="Folklore">Folklore</option>
      </select>

      <input
        id="filterQuery"
        class="filter-input"
        type="text"
        placeholder="Search title / content…"
        oninput="renderArchive()"
      />
    </div>
  </div>

  <!-- Archive list -->
  <div id="archive"></div>

  <!-- Empty state -->
  <div class="empty-state" id="emptyState">
    Nothing here yet.<br>Enter your password and generate today's wonders.
  </div>

  <footer>Made with curiosity · Nicole's World</footer>
</div>

<script>
  // ---- Storage ----
  // Each "batch" = one successful generate() call. It contains 5 items.
  const STORAGE_KEY = 'ncb_archive_v1';

  // ---- Admin ----
  // This is UI-gating only (not server-level). For real security, you'd need server storage + auth.
  const ADMIN_FLAG = 'ncb_admin_session';
  // CHANGE THIS to your own strong secret (or keep it same as SITE_PASSWORD if you want).
  // NOTE: Any secret in front-end code can be discovered by a determined user.
  const ADMIN_PASSWORD = 'CHANGE_ME_TO_A_STRONG_SECRET';

  function isAdmin() {
    return sessionStorage.getItem(ADMIN_FLAG) === 'true';
  }

  function toggleAdmin() {
    if (isAdmin()) {
      sessionStorage.removeItem(ADMIN_FLAG);
      alert('Admin mode OFF');
      updateAdminUI();
      renderArchive();
      return;
    }
    const p = prompt('Enter admin password:');
    if (!p) return;
    if (p === ADMIN_PASSWORD) {
      sessionStorage.setItem(ADMIN_FLAG, 'true');
      alert('Admin mode ON (this session only)');
      updateAdminUI();
      renderArchive();
    } else {
      alert('Incorrect admin password');
    }
  }

  function updateAdminUI() {
    const clearBtn = document.getElementById('clearBtn');
    if (isAdmin()) clearBtn.classList.add('show');
    else clearBtn.classList.remove('show');
  }

  // ---- Generate ----
  async function generate() {
    const password = document.getElementById('passwordInput').value.trim();
    if (!password) { showError('Enter password'); return; }

    const btn    = document.getElementById('genBtn');
    const loader = document.getElementById('loading');
    const errEl  = document.getElementById('errorMsg');

    btn.disabled = true;
    btn.textContent = 'Generating…';
    loader.classList.add('show');
    errEl.textContent = '';

    try {
      const res  = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          password,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          ts: Date.now()
        })
      });

      const data = await res.json();
      if (!res.ok) { showError(data.error || 'Generation failed. Please try again.'); return; }

      saveBatch(data);
      renderArchive();

      document.getElementById('archive').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch {
      showError('Network error. Please try again.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
      loader.classList.remove('show');
    }
  }

  function showError(msg) {
    document.getElementById('errorMsg').textContent = msg;
    document.getElementById('loading').classList.remove('show');
    document.getElementById('genBtn').disabled = false;
    document.getElementById('genBtn').textContent = 'Generate';
  }

  // ---- Storage helpers ----
  function loadBatches() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch { return []; }
  }

  function saveBatch(data) {
    try {
      const batches = loadBatches();
      const batchId = Date.now(); // unique id for this generate call
      batches.unshift({
        id: batchId,
        date: data.date,
        items: data.items,
        savedAt: batchId
      });

      // Optional cap to avoid blowing localStorage: keep last 365 batches (~1 year daily)
      const MAX_BATCHES = 365;
      const trimmed = batches.slice(0, MAX_BATCHES);

      localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmed));
    } catch {}
  }

  function deleteBatch(batchId) {
    if (!isAdmin()) return;
    if (!confirm('Delete this batch from this browser?')) return;
    try {
      const batches = loadBatches().filter(b => String(b.id) !== String(batchId));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(batches));
      renderArchive();
    } catch {}
  }

  function clearAll() {
    if (!isAdmin()) return;
    if (!confirm('Clear ALL archive from this browser? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderArchive();
  }

  // ---- Rendering ----
  function renderArchive() {
    updateAdminUI();

    const batches = loadBatches();
    const container = document.getElementById('archive');
    const emptyState = document.getElementById('emptyState');

    const cat = (document.getElementById('filterCategory')?.value || 'ALL').trim();
    const q = (document.getElementById('filterQuery')?.value || '').trim().toLowerCase();

    container.innerHTML = '';

    if (!batches.length) {
      emptyState.style.display = 'block';
      return;
    }
    emptyState.style.display = 'none';

    // Flatten batches -> items, keeping batch context
    let flat = [];
    for (const batch of batches) {
      const items = Array.isArray(batch.items) ? batch.items : [];
      for (const item of items) {
        flat.push({ batch, item });
      }
    }

    // Filter
    flat = flat.filter(x => {
      const item = x.item || {};
      const categoryOk = (cat === 'ALL') || (String(item.category) === cat);
      if (!categoryOk) return false;

      if (!q) return true;

      const hay = [
        item.title_en, item.title_zh,
        item.content_en, item.content_zh,
        item.insight_en, item.insight_zh
      ].map(v => String(v || '').toLowerCase()).join(' ');

      return hay.includes(q);
    });

    if (!flat.length) {
      container.innerHTML = `<div class="empty-state">No results. Try another category or keyword.</div>`;
      return;
    }

    // Group by batch (newest batch first)
    // We keep batch order as stored (unshift -> newest first)
    const batchOrder = new Map();
    batches.forEach((b, i) => batchOrder.set(String(b.id), i));
    flat.sort((a, b) => (batchOrder.get(String(a.batch.id)) ?? 999999) - (batchOrder.get(String(b.batch.id)) ?? 999999));

    let currentBatchId = null;
    let currentGroupEl = null;

    flat.forEach((x, idx) => {
      const batch = x.batch;
      const item = x.item;

      if (String(batch.id) !== String(currentBatchId)) {
        currentBatchId = batch.id;

        const group = document.createElement('div');
        group.className = 'date-group';
        group.style.animationDelay = (idx * 0.02) + 's';

        const when = new Date(batch.savedAt || Date.now());
        const timeStr = when.toLocaleString(undefined, { hour: '2-digit', minute: '2-digit' });

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
          <span class="section-date">${esc(batch.date || '')}</span>
          <span class="section-meta">
            <span>${esc(timeStr)}</span>
            ${isAdmin() ? `<button class="section-delete" onclick="deleteBatch('${esc(String(batch.id))}')">Delete batch</button>` : ``}
          </span>
        `;
        group.appendChild(header);

        container.appendChild(group);
        currentGroupEl = group;
      }

      const card = document.createElement('div');
      card.className = 'card';

      const uid = `b_${String(currentBatchId)}_${String(item.index || idx)}_${idx}`;
      card.innerHTML = buildCard(item, uid);

      currentGroupEl.appendChild(card);
    });
  }

  function buildCard(item, uid) {
    return `
      <div class="card-top">
        <div class="card-left">
          <span class="card-emoji">${esc(item.emoji)}</span>
          <span class="card-cat">${esc(item.category)}</span>
        </div>
        <span class="card-num">${String(item.index ?? '').padStart(2,'0')}</span>
      </div>

      <div class="card-title-en">${esc(item.title_en)}</div>
      <div class="card-title-zh">${esc(item.title_zh)}</div>

      <div class="lang-tabs">
        <button class="lang-tab active" onclick="switchLang(this,'en','${uid}')">EN</button>
        <button class="lang-tab" onclick="switchLang(this,'zh','${uid}')">中文</button>
      </div>

      <div class="content-block active" id="en-${uid}">
        <p class="card-content">${esc(item.content_en)}</p>
        <div class="card-insight">${esc(item.insight_en)}</div>
      </div>

      <div class="content-block" id="zh-${uid}">
        <p class="card-content">${esc(item.content_zh)}</p>
        <div class="card-insight">${esc(item.insight_zh)}</div>
      </div>

      ${buildSources(item)}
    `;
  }

  function switchLang(btn, lang, uid) {
    const card = btn.closest('.card');
    card.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('active'));
    card.querySelectorAll('.content-block').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(lang + '-' + uid).classList.add('active');
  }

  // ---- Safer link rendering (prevents javascript: etc.) ----
  function safeUrl(u) {
    try {
      const url = new URL(u);
      if (url.protocol !== 'https:') return null;
      return url.toString();
    } catch {
      return null;
    }
  }

  // Supports BOTH old fields (source_name/source_url) and new citations[]
  function buildSources(item) {
    const cites = Array.isArray(item.citations) ? item.citations : null;

    if (cites && cites.length) {
      const links = cites.map(c => {
        const u = safeUrl(c.source_url);
        const label = esc(c.label || '');
        const name  = esc(c.source_name || '');
        const text  = `${label} ${name}`.trim();
        return u
          ? `<a href="${u}" target="_blank" rel="noopener noreferrer">${text}</a>`
          : `<span>${text}</span>`;
      }).join(' ');
      return `<div class="card-source">Source: ${links}</div>`;
    }

    // fallback to old schema
    const u = safeUrl(item.source_url);
    const name = esc(item.source_name || '');
    if (!name && !u) return '';
    return `<div class="card-source">Source: ${
      u ? `<a href="${u}" target="_blank" rel="noopener noreferrer">${name || 'Link'}</a>` : `<span>${name}</span>`
    }</div>`;
  }

  // ---- XSS protection for text nodes ----
  function esc(str) {
    if (typeof str !== 'string') return '';
    return str
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // ---- Init ----
  updateAdminUI();
  renderArchive();
</script>
</body>
</html>
