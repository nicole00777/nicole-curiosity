<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<title>Curiosity Box — Nicole's Daily</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #f5f4f0;
    --surface:   #ffffff;
    --text:      #111111;
    --secondary: #555555;
    --tertiary:  #999999;
    --border:    #e4e3de;
    --border-lt: #eeedea;

    /* Category palette — dusty, refined */
    --psychology:  #6b8fa8;
    --history:     #a07850;
    --nature:      #5f8c6e;
    --culture:     #8a6fa8;
    --philosophy:  #4a7a9b;
    --language:    #b08040;
    --food:        #b86848;
    --art:         #9060a0;
    --science:     #3a7090;
    --folklore:    #708050;
    --default:     #888888;

    --radius: 12px;
    --radius-sm: 8px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html { font-size: 16px; scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', -apple-system, sans-serif;
    font-weight: 300;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ═══════════════════════════════
     LAYOUT
  ═══════════════════════════════ */
  .page {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 40px;
  }

  /* ═══════════════════════════════
     NAV
  ═══════════════════════════════ */
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 28px 0;
    border-bottom: 1px solid var(--border);
    position: relative;
  }

  nav::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, #7c9eb5, #6a9e7a, #b07c5a, #9b7eb8, #c47f6a);
    z-index: 100;
  }

  .nav-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1rem;
    font-weight: 400;
    color: var(--text);
    letter-spacing: 0.3px;
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .nav-link {
    font-size: 12px;
    font-weight: 400;
    color: var(--tertiary);
    background: none;
    border: none;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: color 0.15s;
    display: none;
  }

  .nav-link:hover { color: var(--text); }
  .nav-link.danger:hover { color: #c0392b; }
  .nav-link.show { display: inline; }

  /* ═══════════════════════════════
     HERO
  ═══════════════════════════════ */
  .hero {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    padding: 72px 0 64px;
    border-bottom: 1px solid var(--border);
    align-items: end;
  }

  .hero-left {}

  .hero-kicker {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 3.5px;
    text-transform: uppercase;
    color: var(--tertiary);
    margin-bottom: 24px;
  }

  .hero-title {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2.8rem, 4.5vw, 4.2rem);
    font-weight: 400;
    line-height: 1.06;
    letter-spacing: -0.5px;
    color: var(--text);
    margin-bottom: 20px;
  }

  .hero-title em {
    font-style: italic;
    color: var(--secondary);
  }

  .hero-sub {
    font-size: 14px;
    color: var(--secondary);
    line-height: 1.75;
    max-width: 320px;
  }

  .hero-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 12px;
    padding-bottom: 4px;
  }

  .gen-row {
    display: flex;
    gap: 8px;
    align-items: center;
    width: 100%;
    justify-content: flex-end;
  }

  .password-input {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 300;
    color: var(--text);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 11px 16px;
    width: 148px;
    outline: none;
    transition: border-color 0.2s;
  }

  .password-input::placeholder { color: #ccc; }
  .password-input:focus { border-color: #888; }

  .gen-btn {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.5px;
    background: var(--text);
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    padding: 12px 24px;
    cursor: pointer;
    transition: background 0.18s, transform 0.1s;
    white-space: nowrap;
  }

  .gen-btn:hover { background: #2a2a2a; transform: translateY(-1px); }
  .gen-btn:active { transform: translateY(0px); }
  .gen-btn:disabled { opacity: 0.28; cursor: not-allowed; transform: none; }

  .error-msg {
    font-size: 12px;
    color: #c0392b;
    min-height: 16px;
    text-align: right;
    width: 100%;
  }

  /* ═══════════════════════════════
     LOADING
  ═══════════════════════════════ */
  .loading {
    display: none;
    padding: 48px 0 16px;
    text-align: center;
  }

  .loading.show { display: block; }

  .loading-track {
    width: 36px;
    height: 1px;
    background: var(--border);
    margin: 0 auto 16px;
    overflow: hidden;
    position: relative;
  }

  .loading-track::after {
    content: '';
    position: absolute;
    left: -100%; width: 100%; height: 100%;
    background: var(--text);
    animation: sweep 1s ease-in-out infinite;
  }

  .loading-label {
    font-size: 11px;
    color: var(--tertiary);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  /* ═══════════════════════════════
     ARCHIVE TOOLBAR
  ═══════════════════════════════ */
  .toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 28px 0 24px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .toolbar-left {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--tertiary);
  }

  .toolbar-right {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .filter-select, .filter-input {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 300;
    color: var(--text);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    outline: none;
    transition: border-color 0.15s;
  }

  .filter-input { width: 180px; }
  .filter-select:focus, .filter-input:focus { border-color: #888; }

  /* ═══════════════════════════════
     DATE GROUP
  ═══════════════════════════════ */
  .date-group {
    margin-bottom: 60px;
    animation: riseIn 0.4s ease both;
  }

  .group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-bottom: 14px;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }

  .group-date {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--tertiary);
  }

  .group-meta {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 11px;
    color: var(--tertiary);
  }

  .group-delete {
    font-size: 11px;
    color: var(--tertiary);
    background: none;
    border: none;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: color 0.15s;
    padding: 0;
  }

  .group-delete:hover { color: #c0392b; }

  /* ═══════════════════════════════
     CARDS — 2-column grid
  ═══════════════════════════════ */
  .cards-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  /* First card spans full width */
  .cards-grid .card:first-child {
    grid-column: 1 / -1;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.18s;
    cursor: default;
  }

  .card:hover {
    box-shadow: 0 8px 32px rgba(0,0,0,0.07);
    transform: translateY(-2px);
  }

  /* Top accent bar — category color */
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--cat-color, var(--default));
    opacity: 0.7;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 7px;
  }

  .card-emoji { font-size: 16px; line-height: 1; }

  .card-cat {
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--cat-color, var(--default));
  }

  .card-num {
    font-size: 10px;
    color: var(--border);
    letter-spacing: 0.5px;
  }

  .card-title-en {
    font-family: 'DM Serif Display', serif;
    font-size: 1.15rem;
    font-weight: 400;
    line-height: 1.3;
    color: var(--text);
    margin-bottom: 3px;
    letter-spacing: -0.1px;
  }

  /* full-width first card gets bigger title */
  .card:first-child .card-title-en {
    font-size: 1.45rem;
  }

  .card-title-zh {
    font-size: 11px;
    color: var(--tertiary);
    margin-bottom: 16px;
    font-weight: 300;
  }

  /* lang toggle */
  .lang-tabs {
    display: inline-flex;
    gap: 1px;
    margin-bottom: 12px;
    background: #f0efeb;
    border-radius: 6px;
    padding: 2px;
  }

  .lang-tab {
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    font-weight: 400;
    letter-spacing: 0.5px;
    padding: 4px 12px;
    border-radius: 5px;
    border: none;
    background: none;
    color: var(--tertiary);
    cursor: pointer;
    transition: all 0.15s;
  }

  .lang-tab.active {
    background: var(--surface);
    color: var(--text);
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  }

  .content-block { display: none; }
  .content-block.active { display: block; animation: fadeIn 0.2s ease both; }

  .card-content {
    font-size: 13.5px;
    color: #2a2a2a;
    line-height: 1.85;
    margin-bottom: 12px;
    font-weight: 300;
  }

  .card-insight {
    font-size: 12.5px;
    color: var(--secondary);
    font-style: italic;
    line-height: 1.65;
    padding-top: 12px;
    border-top: 1px solid var(--border-lt);
    margin-bottom: 12px;
    font-family: 'DM Serif Display', serif;
    font-weight: 400;
  }

  .card-source {
    font-size: 10.5px;
    color: var(--tertiary);
  }

  .card-source span { font-style: italic; }

  /* ═══════════════════════════════
     EMPTY STATE
  ═══════════════════════════════ */
  .empty-state {
    text-align: center;
    padding: 72px 0 96px;
    color: var(--tertiary);
    font-size: 13px;
    font-weight: 300;
    line-height: 2;
  }

  /* ═══════════════════════════════
     FOOTER
  ═══════════════════════════════ */
  footer {
    border-top: 1px solid var(--border);
    padding: 28px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 40px;
  }

  .footer-l {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--tertiary);
  }

  .footer-r {
    font-size: 10px;
    color: var(--border);
    letter-spacing: 1px;
  }

  /* ═══════════════════════════════
     ANIMATIONS
  ═══════════════════════════════ */
  @keyframes riseIn {
    from { opacity: 0; transform: translateY(14px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  @keyframes sweep {
    0%   { left: -100%; }
    100% { left: 100%; }
  }

  /* ═══════════════════════════════
     RESPONSIVE
  ═══════════════════════════════ */
  @media (max-width: 720px) {
    .page { padding: 0 20px; }

    .hero {
      grid-template-columns: 1fr;
      gap: 40px;
      padding: 48px 0 40px;
    }

    .hero-right {
      align-items: flex-start;
    }

    .gen-row { justify-content: flex-start; }

    .cards-grid {
      grid-template-columns: 1fr;
    }

    .card:first-child {
      grid-column: auto;
    }

    .card:first-child .card-title-en {
      font-size: 1.15rem;
    }

    .toolbar { flex-direction: column; align-items: flex-start; }
    .toolbar-right { flex-wrap: wrap; }
    .filter-input { width: 100%; }

    footer { flex-direction: column; gap: 6px; }
  }
</style>
</head>

<body>
<div class="page">

  <!-- NAV -->
  <nav>
    <span class="nav-logo">Curiosity Box</span>
    <div class="nav-right">
      <button class="nav-link danger" id="clearBtn" onclick="clearAll()">Clear all</button>
    </div>
  </nav>

  <!-- HERO -->
  <div class="hero">
    <div class="hero-left">
      <div class="hero-kicker">Nicole's Daily</div>
      <h1 class="hero-title">Five things<br>worth <em>knowing.</em></h1>
      <p class="hero-sub">Surprising, sharp, and a little wicked —<br>one curiosity box per day.</p>
    </div>

    <div class="hero-right">
      <div class="gen-row">
        <input
          type="password"
          class="password-input"
          id="passwordInput"
          placeholder="Password"
          onkeydown="if(event.key==='Enter') generate()"
        />
        <button class="gen-btn" id="genBtn" onclick="generate()">Generate</button>
      </div>
      <div class="error-msg" id="errorMsg"></div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="loading-track"></div>
    <p class="loading-label">Collecting wonders</p>
  </div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <span class="toolbar-left">Archive</span>
    <div class="toolbar-right">
      <select id="filterCategory" class="filter-select" onchange="renderArchive()">
        <option value="ALL">All categories</option>
        <option value="Psychology">Psychology</option>
        <option value="History">History</option>
        <option value="Nature">Nature</option>
        <option value="Culture">Culture</option>
        <option value="Philosophy">Philosophy</option>
        <option value="Language">Language</option>
        <option value="Food">Food</option>
        <option value="Art">Art</option>
        <option value="Science">Science</option>
        <option value="Folklore">Folklore</option>
      </select>
      <input
        id="filterQuery"
        class="filter-input"
        type="text"
        placeholder="Search…"
        oninput="renderArchive()"
      />
    </div>
  </div>

  <!-- ARCHIVE -->
  <div id="archive"></div>

  <!-- EMPTY -->
  <div class="empty-state" id="emptyState">
    Nothing yet.<br>Enter your password and generate today's wonders.
  </div>

  <footer>
    <span class="footer-l">Nicole's World</span>
    <span class="footer-r">Made with curiosity</span>
  </footer>

</div>

<script>
  const STORAGE_KEY = 'ncb_archive_v1';

  const CAT_COLORS = {
    Psychology:  'var(--psychology)',
    History:     'var(--history)',
    Nature:      'var(--nature)',
    Culture:     'var(--culture)',
    Philosophy:  'var(--philosophy)',
    Language:    'var(--language)',
    Food:        'var(--food)',
    Art:         'var(--art)',
    Science:     'var(--science)',
    Folklore:    'var(--folklore)',
  };

  // ── GENERATE ──
  async function generate() {
    const pw  = document.getElementById('passwordInput').value.trim();
    if (!pw) { showError('Enter password'); return; }

    const btn    = document.getElementById('genBtn');
    const loader = document.getElementById('loading');
    const errEl  = document.getElementById('errorMsg');

    btn.disabled = true;
    btn.textContent = 'Generating…';
    loader.classList.add('show');
    errEl.textContent = '';

    try {
      const res  = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          password: pw,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          ts: Date.now()
        })
      });

      const data = await res.json();
      if (!res.ok) { showError(data.error || 'Generation failed.'); return; }

      saveBatch(data);
      renderArchive();
      document.getElementById('archive').scrollIntoView({ behavior: 'smooth', block: 'start' });

    } catch {
      showError('Network error. Please try again.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate';
      loader.classList.remove('show');
    }
  }

  function showError(msg) {
    document.getElementById('errorMsg').textContent = msg;
    document.getElementById('loading').classList.remove('show');
    document.getElementById('genBtn').disabled = false;
    document.getElementById('genBtn').textContent = 'Generate';
  }

  // ── STORAGE ──
  function loadBatches() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch { return []; }
  }

  function saveBatch(data) {
    try {
      const batches = loadBatches();
      const id = Date.now();
      batches.unshift({ id, date: data.date, items: data.items, savedAt: id });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(batches.slice(0, 365)));
    } catch {}
  }

  function deleteBatch(id) {
    if (!confirm('Delete this batch?')) return;
    try {
      localStorage.setItem(STORAGE_KEY,
        JSON.stringify(loadBatches().filter(b => String(b.id) !== String(id))));
      renderArchive();
    } catch {}
  }

  function clearAll() {
    if (!confirm('Clear ALL history? This cannot be undone.')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderArchive();
  }

  // ── RENDER ──
  function renderArchive() {
    const batches   = loadBatches();
    const container = document.getElementById('archive');
    const empty     = document.getElementById('emptyState');
    const clearBtn  = document.getElementById('clearBtn');

    const cat = (document.getElementById('filterCategory')?.value || 'ALL').trim();
    const q   = (document.getElementById('filterQuery')?.value || '').trim().toLowerCase();

    container.innerHTML = '';

    if (!batches.length) {
      empty.style.display = 'block';
      clearBtn.classList.remove('show');
      return;
    }

    empty.style.display = 'none';
    clearBtn.classList.add('show');

    // Flatten + filter
    let flat = [];
    for (const batch of batches) {
      for (const item of (batch.items || [])) flat.push({ batch, item });
    }

    flat = flat.filter(({ item }) => {
      if (cat !== 'ALL' && String(item.category) !== cat) return false;
      if (!q) return true;
      const hay = [item.title_en, item.title_zh, item.content_en, item.content_zh]
        .map(v => String(v || '').toLowerCase()).join(' ');
      return hay.includes(q);
    });

    if (!flat.length) {
      container.innerHTML = '<div class="empty-state">No results. Try another filter.</div>';
      return;
    }

    // Group by batch
    let curId = null, curGrid = null;
    let cardIdx = 0;

    flat.forEach(({ batch, item }, idx) => {
      if (String(batch.id) !== String(curId)) {
        curId = batch.id;
        cardIdx = 0;

        const group = document.createElement('div');
        group.className = 'date-group';
        group.style.animationDelay = (idx * 0.03) + 's';

        const timeStr = new Date(batch.savedAt || Date.now())
          .toLocaleString(undefined, { hour: '2-digit', minute: '2-digit' });

        const header = document.createElement('div');
        header.className = 'group-header';
        header.innerHTML = `
          <span class="group-date">${esc(batch.date || '')}</span>
          <span class="group-meta">
            <span>${esc(timeStr)}</span>
            <button class="group-delete" onclick="deleteBatch('${esc(String(batch.id))}')">Delete</button>
          </span>
        `;
        group.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'cards-grid';
        group.appendChild(grid);
        container.appendChild(group);
        curGrid = grid;
      }

      const card = document.createElement('div');
      card.className = 'card';
      card.style.setProperty('--cat-color', CAT_COLORS[item.category] || 'var(--default)');

      const uid = `c${String(curId)}_${idx}`;
      card.innerHTML = buildCard(item, uid);
      curGrid.appendChild(card);
      cardIdx++;
    });
  }

  function buildCard(item, uid) {
    return `
      <div class="card-header">
        <div class="card-meta">
          <span class="card-emoji">${esc(item.emoji)}</span>
          <span class="card-cat">${esc(item.category)}</span>
        </div>
        <span class="card-num">${String(item.index ?? '').padStart(2,'0')}</span>
      </div>
      <div class="card-title-en">${esc(item.title_en)}</div>
      <div class="card-title-zh">${esc(item.title_zh)}</div>
      <div class="lang-tabs">
        <button class="lang-tab active" onclick="switchLang(this,'en','${uid}')">EN</button>
        <button class="lang-tab" onclick="switchLang(this,'zh','${uid}')">中文</button>
      </div>
      <div class="content-block active" id="en-${uid}">
        <p class="card-content">${esc(item.content_en)}</p>
        <div class="card-insight">${esc(item.insight_en)}</div>
      </div>
      <div class="content-block" id="zh-${uid}">
        <p class="card-content">${esc(item.content_zh)}</p>
        <div class="card-insight">${esc(item.insight_zh)}</div>
      </div>
      ${item.source_name ? `<div class="card-source">Source: <span>${esc(item.source_name)}</span></div>` : ''}
    `;
  }

  function switchLang(btn, lang, uid) {
    const card = btn.closest('.card');
    card.querySelectorAll('.lang-tab').forEach(t => t.classList.remove('active'));
    card.querySelectorAll('.content-block').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(lang + '-' + uid).classList.add('active');
  }

  function esc(str) {
    if (typeof str !== 'string') return '';
    return str
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  renderArchive();
</script>
</body>
</html>
